#!/usr/bin/env python3
"""Test malware platform configuration"""

import os
import sys

def test_virustotal():
    """Test VirusTotal configuration"""
    # Check environment variable
    api_key = os.getenv('VIRUSTOTAL_API_KEY')
    
    # Check .env file
    if not api_key:
        try:
            env_file = 'backend/.env'
            if os.path.exists(env_file):
                with open(env_file, 'r') as f:
                    for line in f:
                        line = line.strip()
                        if line.startswith('VIRUSTOTAL_API_KEY=') and not line.startswith('#'):
                            key = line.split('=', 1)[1].strip().strip('"').strip("'")
                            if key and key != 'paste_your_api_key_here':
                                api_key = key
                                break
        except:
            pass
    
    if api_key:
        print("‚úÖ VirusTotal: Configured")
        print(f"   API Key: {api_key[:10]}...")
        return True
    else:
        print("‚ùå VirusTotal: Not configured")
        print("   Add API key to: backend/.env")
        return False

def test_clamav():
    """Test ClamAV availability"""
    try:
        import pyclamd
        try:
            cd = pyclamd.ClamdUnixSocket()
            if not cd.ping():
                cd = pyclamd.ClamdNetworkSocket()
            
            if cd and cd.ping():
                version = cd.version()
                print("‚úÖ ClamAV: Available and running")
                print(f"   Version: {version}")
                return True
            else:
                print("‚ö†Ô∏è  ClamAV: Installed but daemon not running")
                print("   Start daemon: clamd or systemctl start clamav-daemon")
                return False
        except:
            print("‚ö†Ô∏è  ClamAV: Installed but daemon not running")
            print("   Start daemon: clamd or systemctl start clamav-daemon")
            return False
    except ImportError:
        print("‚ùå ClamAV: Not available")
        print("   Install: pip install pyclamd")
        return False

def test_yara():
    """Test YARA availability"""
    try:
        import yara
        print("‚úÖ YARA: Available")
        print(f"   Version: {yara.__version__ if hasattr(yara, '__version__') else 'Unknown'}")
        return True
    except ImportError:
        print("‚ùå YARA: Not available")
        print("   Install: pip install yara-python")
        return False

def test_static_analysis():
    """Test static analysis (always available)"""
    print("‚úÖ Static Analysis: Always available")
    print("   Features: String extraction, keyword detection")
    return True

def test_backend_connection():
    """Test backend server"""
    try:
        import requests
        response = requests.get('http://localhost:8001/', timeout=2)
        if response.status_code == 200:
            print("‚úÖ Backend: Running on port 8001")
            return True
        else:
            print("‚ö†Ô∏è  Backend: Unexpected response")
            return False
    except:
        print("‚ùå Backend: Not running")
        print("   Start: python -m app.main (in backend folder)")
        return False

if __name__ == "__main__":
    print("="*60)
    print("Malware Analysis Platform - Configuration Test")
    print("="*60)
    print()
    
    print("Testing Scanners:")
    print("-" * 60)
    results = {
        'VirusTotal': test_virustotal(),
        'ClamAV': test_clamav(),
        'YARA': test_yara(),
        'Static Analysis': test_static_analysis()
    }
    
    print()
    print("Testing Backend:")
    print("-" * 60)
    backend_running = test_backend_connection()
    
    print()
    print("="*60)
    active = sum(results.values())
    print(f"Active Scanners: {active}/4")
    print("="*60)
    print()
    
    if active == 4:
        print("üéâ Excellent! All scanners are configured and available.")
    elif active >= 2:
        print("‚úÖ Platform ready for analysis!")
        print("   Consider installing optional scanners for better detection.")
    else:
        print("‚ö†Ô∏è  Platform will work with limited functionality.")
        print("   Install optional scanners for enhanced detection.")
    
    print()
    print("Recommendations:")
    if not results['VirusTotal']:
        print("  ‚Ä¢ Get free VirusTotal API key: https://www.virustotal.com")
    if not results['ClamAV']:
        print("  ‚Ä¢ Install ClamAV for local scanning")
    if not results['YARA']:
        print("  ‚Ä¢ Install YARA for pattern detection")
    if not backend_running:
        print("  ‚Ä¢ Start backend server before using the platform")
    
    print()
    print("For setup instructions, see: CONFIGURATION_GUIDE.md")
    print("="*60)
