"""
Malware Analysis Platform - Main API
FastAPI backend for comprehensive malware analysis
"""
from fastapi import FastAPI, UploadFile, File, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from contextlib import asynccontextmanager
from datetime import datetime
import json
from typing import Dict

# Import analysis modules
from app.hash_analyzer import generate_file_hashes
from app.virustotal_checker import VirusTotalChecker
from app.yara_scanner import YaraScanner
from app.static_analyzer import StaticAnalyzer
from app.risk_calculator import RiskCalculator


# ============================================================================
# GLOBAL SCANNERS
# ============================================================================

virustotal_checker = None
yara_scanner = None
static_analyzer = None


# ============================================================================
# LIFESPAN CONTEXT
# ============================================================================

@asynccontextmanager
async def lifespan(app: FastAPI):
    """Initialize scanners on startup"""
    global virustotal_checker, yara_scanner, static_analyzer
    
    print("="*60)
    print("ðŸ›¡ï¸  Malware Analysis Platform - Initializing")
    print("="*60)
    
    # Initialize all scanners
    virustotal_checker = VirusTotalChecker()
    print("âœ… VirusTotal checker initialized")
    
    yara_scanner = YaraScanner()
    if yara_scanner.available:
        print("âœ… YARA scanner initialized")
    else:
        print("âš ï¸  YARA not available (optional)")
    
    static_analyzer = StaticAnalyzer()
    print("âœ… Static analyzer initialized")
    
    print("="*60)
    print("ðŸš€ Malware Analysis Platform Ready")
    print("="*60)
    
    yield
    
    # Cleanup on shutdown
    print("Shutting down Malware Analysis Platform...")


# ============================================================================
# FASTAPI APP
# ============================================================================

app = FastAPI(
    title="Malware Analysis Platform API",
    description="Comprehensive malware analysis with multiple scanning engines",
    version="1.0.0",
    lifespan=lifespan
)

# CORS Configuration
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5171", "http://localhost:3000", "http://localhost:8000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# ============================================================================
# API ENDPOINTS
# ============================================================================

@app.get("/")
async def root():
    """Health check endpoint"""
    return {
        "status": "online",
        "service": "Malware Analysis Platform",
        "version": "1.0.0",
        "features": [
            "Hash Generation (MD5, SHA1, SHA256)",
            "VirusTotal Integration",
            "ClamAV Scanning",
            "YARA Rule Detection",
            "Static Analysis"
        ]
    }


@app.get("/api/status")
async def get_status():
    """Get scanner availability status"""
    return {
        "virustotal": "configured" if virustotal_checker.api_key else "not_configured",
        "yara": "available" if yara_scanner.available else "unavailable",
        "static_analyzer": "available"
    }


@app.post("/api/analyze")
async def analyze_file(file: UploadFile = File(...)):
    """
    Comprehensive malware analysis endpoint
    
    Performs:
    1. Hash generation (MD5, SHA1, SHA256)
    2. VirusTotal lookup
    3. YARA rule matching
    4. Static analysis
    5. Risk level calculation
    
    Returns structured JSON report
    """
    try:
        # Read file content
        file_content = await file.read()
        file_size = len(file_content)
        
        # Validate file size (max 50MB)
        if file_size > 50 * 1024 * 1024:
            raise HTTPException(status_code=400, detail="File too large (max 50MB)")
        
        if file_size == 0:
            raise HTTPException(status_code=400, detail="File is empty")
        
        print(f"\nðŸ“ Analyzing file: {file.filename} ({file_size} bytes)")
        
        # 1. Generate hashes
        print("ðŸ” Generating hashes...")
        hashes = generate_file_hashes(file_content)
        
        # 2. VirusTotal check
        print("ðŸŒ Checking VirusTotal...")
        vt_result = virustotal_checker.check_hash(hashes['sha256'])
        
        # 3. YARA scan
        print("ðŸ” Running YARA scan...")
        yara_result = yara_scanner.scan_file(file_content)
        
        # 4. Static analysis
        print("ðŸ“Š Performing static analysis...")
        static_result = static_analyzer.analyze_file(file_content)
        
        # 5. Calculate risk level
        print("âš–ï¸  Calculating risk level...")
        risk_assessment = RiskCalculator.calculate_risk(
            vt_result,
            yara_result,
            static_result
        )
        
        # Generate analysis report
        report = {
            "analysis_id": f"analysis_{datetime.now().strftime('%Y%m%d_%H%M%S')}",
            "timestamp": datetime.now().isoformat(),
            "file_info": {
                "filename": file.filename,
                "size_bytes": file_size,
                "size_human": format_file_size(file_size)
            },
            "hashes": hashes,
            "scan_results": {
                "virustotal": vt_result,
                "yara": yara_result,
                "static_analysis": static_result
            },
            "risk_assessment": risk_assessment
        }
        
        print(f"âœ… Analysis complete - Risk Level: {risk_assessment['risk_level']}\n")
        
        return report
        
    except HTTPException:
        raise
    except Exception as e:
        print(f"âŒ Analysis error: {str(e)}")
        raise HTTPException(status_code=500, detail=f"Analysis failed: {str(e)}")


# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

def format_file_size(size_bytes: int) -> str:
    """Format file size in human-readable format"""
    for unit in ['B', 'KB', 'MB', 'GB']:
        if size_bytes < 1024.0:
            return f"{size_bytes:.2f} {unit}"
        size_bytes /= 1024.0
    return f"{size_bytes:.2f} TB"


# ============================================================================
# MAIN
# ============================================================================

if __name__ == "__main__":
    import uvicorn
    
    print("Starting Malware Analysis Platform...")
    
    uvicorn.run(
        "app.main:app",
        host="0.0.0.0",
        port=8001,
        reload=True,
        log_level="info"
    )
