"""
VirusTotal API Integration Module
Checks file hashes against VirusTotal database
"""
import requests
from typing import Dict, Optional
import os
from pathlib import Path


class VirusTotalChecker:
    """VirusTotal API integration for hash checking"""
    
    def __init__(self, api_key: Optional[str] = None):
        """
        Initialize VirusTotal checker
        
        Args:
            api_key: VirusTotal API key (optional, can use env variable or .env file)
        """
        # Try to load from .env file if exists
        if not api_key:
            api_key = self._load_from_env_file()
        
        # Fall back to environment variable
        self.api_key = api_key or os.getenv('VIRUSTOTAL_API_KEY', '')
    
    def _load_from_env_file(self) -> Optional[str]:
        """Load API key from .env file"""
        try:
            env_file = Path(__file__).parent.parent / '.env'
            if env_file.exists():
                with open(env_file, 'r') as f:
                    for line in f:
                        line = line.strip()
                        if line.startswith('VIRUSTOTAL_API_KEY=') and not line.startswith('#'):
                            key = line.split('=', 1)[1].strip()
                            # Remove quotes if present
                            key = key.strip('"').strip("'")
                            if key and key != 'paste_your_api_key_here':
                                return key
        except Exception as e:
            print(f"Note: Could not read .env file: {e}")
        return None
        self.base_url = "https://www.virustotal.com/api/v3"
        
    def check_hash(self, file_hash: str) -> Dict:
        """
        Check if a file hash is flagged as malicious
        
        Args:
            file_hash: SHA256 hash of the file
            
        Returns:
            Dictionary with VirusTotal scan results
        """
        if not self.api_key:
            return {
                'status': 'disabled',
                'message': 'VirusTotal API key not configured',
                'malicious': 0,
                'total': 0
            }
        
        try:
            headers = {
                'x-apikey': self.api_key
            }
            
            url = f"{self.base_url}/files/{file_hash}"
            response = requests.get(url, headers=headers, timeout=10)
            
            if response.status_code == 404:
                return {
                    'status': 'not_found',
                    'message': 'File not found in VirusTotal database',
                    'malicious': 0,
                    'total': 0
                }
            
            if response.status_code == 200:
                data = response.json()
                stats = data.get('data', {}).get('attributes', {}).get('last_analysis_stats', {})
                
                return {
                    'status': 'found',
                    'malicious': stats.get('malicious', 0),
                    'suspicious': stats.get('suspicious', 0),
                    'undetected': stats.get('undetected', 0),
                    'total': sum(stats.values()),
                    'scan_date': data.get('data', {}).get('attributes', {}).get('last_analysis_date', 'N/A')
                }
            
            return {
                'status': 'error',
                'message': f'API returned status code {response.status_code}',
                'malicious': 0,
                'total': 0
            }
            
        except requests.exceptions.Timeout:
            return {
                'status': 'timeout',
                'message': 'VirusTotal API request timed out',
                'malicious': 0,
                'total': 0
            }
        except Exception as e:
            return {
                'status': 'error',
                'message': f'VirusTotal check failed: {str(e)}',
                'malicious': 0,
                'total': 0
            }
