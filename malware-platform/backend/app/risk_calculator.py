"""
Risk Level Calculator Module
Calculates overall risk level based on all scan results
"""
from typing import Dict


class RiskCalculator:
    """Calculate risk level from multiple scan results"""
    
    @staticmethod
    def calculate_risk(
        virustotal_result: Dict,
        yara_result: Dict,
        static_analysis: Dict
    ) -> Dict:
        """
        Calculate overall risk level
        
        Args:
            virustotal_result: VirusTotal scan results
            yara_result: YARA scan results
            static_analysis: Static analysis results
            
        Returns:
            Dictionary with risk level and score
        """
        risk_score = 0
        risk_factors = []
        
        # VirusTotal analysis (0-50 points)
        if virustotal_result.get('status') == 'found':
            malicious = virustotal_result.get('malicious', 0)
            total = virustotal_result.get('total', 1)
            
            if malicious > 0:
                vt_score = min(50, (malicious / max(total, 1)) * 100)
                risk_score += vt_score
                risk_factors.append(f"VirusTotal: {malicious}/{total} engines detected malware")
        
        # YARA analysis (0-30 points)
        if yara_result.get('threat_detected'):
            matches = len(yara_result.get('matches', []))
            yara_score = min(30, matches * 10)
            risk_score += yara_score
            risk_factors.append(f"YARA: {matches} suspicious patterns detected")
        
        # Static analysis (0-20 points)
        if static_analysis.get('has_suspicious_content'):
            suspicious_count = static_analysis.get('suspicious_keywords', {}).get('total_detected', 0)
            static_score = min(20, suspicious_count * 3)
            risk_score += static_score
            risk_factors.append(f"Static: {suspicious_count} suspicious keywords found")
        
        # Determine risk level
        if risk_score >= 60:
            risk_level = "HIGH"
            risk_color = "danger"
        elif risk_score >= 30:
            risk_level = "MEDIUM"
            risk_color = "warning"
        else:
            risk_level = "LOW"
            risk_color = "success"
        
        return {
            'risk_level': risk_level,
            'risk_score': round(risk_score, 2),
            'risk_color': risk_color,
            'risk_factors': risk_factors,
            'recommendation': RiskCalculator._get_recommendation(risk_level)
        }
    
    @staticmethod
    def _get_recommendation(risk_level: str) -> str:
        """Get security recommendation based on risk level"""
        recommendations = {
            'HIGH': 'CRITICAL: Do not execute this file. It shows strong indicators of malicious behavior. Delete immediately and scan your system.',
            'MEDIUM': 'WARNING: This file shows suspicious characteristics. Exercise extreme caution. Do not execute without thorough investigation.',
            'LOW': 'This file appears relatively safe, but always exercise caution with unknown files. Verify the source before execution.'
        }
        return recommendations.get(risk_level, 'Unknown risk level')
