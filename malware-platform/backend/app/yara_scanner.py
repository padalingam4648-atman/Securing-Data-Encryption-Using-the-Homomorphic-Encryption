"""
YARA Rule Scanner Module
Pattern-based malware detection using YARA rules
"""
from typing import Dict, List
import os

try:
    import yara
    YARA_AVAILABLE = True
except ImportError:
    YARA_AVAILABLE = False


class YaraScanner:
    """YARA rule-based scanner for suspicious patterns"""
    
    def __init__(self, rules_path: str = None):
        """
        Initialize YARA scanner
        
        Args:
            rules_path: Path to YARA rules file (optional)
        """
        self.rules = None
        self.available = False
        
        if not YARA_AVAILABLE:
            print("YARA not available - install with: pip install yara-python")
            return
        
        # Default embedded rules for common malware patterns
        self.default_rules = """
        rule SuspiciousStrings {
            meta:
                description = "Detects suspicious strings commonly found in malware"
                severity = "medium"
            strings:
                $cmd1 = "cmd.exe" nocase
                $cmd2 = "powershell" nocase
                $cmd3 = "wscript" nocase
                $cmd4 = "cscript" nocase
                $reg1 = "HKEY_LOCAL_MACHINE" nocase
                $reg2 = "SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run" nocase
                $net1 = "URLDownloadToFile" nocase
                $net2 = "InternetOpen" nocase
                $net3 = "HttpSendRequest" nocase
            condition:
                any of them
        }
        
        rule Ransomware_Indicators {
            meta:
                description = "Detects potential ransomware indicators"
                severity = "high"
            strings:
                $enc1 = "encrypt" nocase
                $enc2 = "decrypt" nocase
                $enc3 = "AES" nocase
                $enc4 = "RSA" nocase
                $msg1 = "bitcoin" nocase
                $msg2 = "ransom" nocase
                $msg3 = "payment" nocase
                $ext1 = ".locked"
                $ext2 = ".encrypted"
            condition:
                (2 of ($enc*)) and (1 of ($msg*) or 1 of ($ext*))
        }
        
        rule Keylogger_Indicators {
            meta:
                description = "Detects potential keylogger behavior"
                severity = "high"
            strings:
                $key1 = "GetAsyncKeyState" nocase
                $key2 = "GetKeyState" nocase
                $key3 = "SetWindowsHookEx" nocase
                $key4 = "keylog" nocase
            condition:
                any of them
        }
        
        rule Backdoor_Indicators {
            meta:
                description = "Detects potential backdoor indicators"
                severity = "high"
            strings:
                $sock1 = "socket" nocase
                $sock2 = "bind" nocase
                $sock3 = "listen" nocase
                $sock4 = "accept" nocase
                $cmd1 = "CreateProcess" nocase
                $cmd2 = "ShellExecute" nocase
            condition:
                (2 of ($sock*)) and (1 of ($cmd*))
        }
        """
        
        try:
            # Try to load custom rules if provided
            if rules_path and os.path.exists(rules_path):
                self.rules = yara.compile(filepath=rules_path)
            else:
                # Use default embedded rules
                self.rules = yara.compile(source=self.default_rules)
            
            self.available = True
        except Exception as e:
            print(f"YARA initialization warning: {e}")
            self.available = False
    
    def scan_file(self, file_content: bytes) -> Dict:
        """
        Scan file content using YARA rules
        
        Args:
            file_content: Binary content of the file
            
        Returns:
            Dictionary with YARA scan results
        """
        if not self.available:
            return {
                'status': 'disabled',
                'message': 'YARA scanner not available (optional - install yara-python)',
                'matches': [],
                'threat_detected': False
            }
        
        try:
            matches = self.rules.match(data=file_content)
            
            match_details = []
            for match in matches:
                match_info = {
                    'rule': match.rule,
                    'tags': match.tags,
                    'meta': match.meta,
                    'strings': [(s[1], s[2].decode('utf-8', errors='ignore')[:50]) for s in match.strings[:5]]
                }
                match_details.append(match_info)
            
            return {
                'status': 'completed',
                'message': f'Found {len(matches)} YARA rule matches',
                'matches': match_details,
                'threat_detected': len(matches) > 0
            }
            
        except Exception as e:
            return {
                'status': 'error',
                'message': f'YARA scan failed: {str(e)}',
                'matches': [],
                'threat_detected': False
            }
