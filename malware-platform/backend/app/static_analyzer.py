"""
Static Analysis Module
Extracts strings and detects suspicious keywords from files
"""
import re
from typing import Dict, List


class StaticAnalyzer:
    """Static analysis for extracting strings and detecting suspicious patterns"""
    
    # Suspicious keywords to detect
    SUSPICIOUS_KEYWORDS = [
        'cmd.exe', 'powershell', 'wscript', 'cscript', 'mshta',
        'regsvr32', 'rundll32', 'certutil', 'bitsadmin',
        'HKEY_LOCAL_MACHINE', 'HKEY_CURRENT_USER',
        'SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run',
        'CreateRemoteThread', 'VirtualAllocEx', 'WriteProcessMemory',
        'URLDownloadToFile', 'InternetOpen', 'HttpSendRequest',
        'ShellExecute', 'WinExec', 'CreateProcess',
        'keylog', 'password', 'credential', 'bitcoin', 'ransom',
        'encrypt', 'decrypt', 'payload', 'backdoor', 'rootkit'
    ]
    
    def __init__(self):
        """Initialize static analyzer"""
        pass
    
    def extract_strings(self, file_content: bytes, min_length: int = 4) -> List[str]:
        """
        Extract readable ASCII strings from binary content
        
        Args:
            file_content: Binary content of the file
            min_length: Minimum string length to extract
            
        Returns:
            List of extracted strings
        """
        try:
            # Extract ASCII strings
            ascii_pattern = rb'[\x20-\x7E]{' + str(min_length).encode() + rb',}'
            ascii_strings = re.findall(ascii_pattern, file_content)
            
            # Extract Unicode strings
            unicode_pattern = rb'(?:[\x20-\x7E][\x00]){' + str(min_length).encode() + rb',}'
            unicode_strings = re.findall(unicode_pattern, file_content)
            
            # Decode and combine
            strings = []
            for s in ascii_strings[:500]:  # Limit to first 500 strings
                try:
                    strings.append(s.decode('ascii'))
                except:
                    pass
            
            for s in unicode_strings[:100]:  # Limit unicode strings
                try:
                    strings.append(s.decode('utf-16le'))
                except:
                    pass
            
            return strings
            
        except Exception as e:
            print(f"String extraction error: {e}")
            return []
    
    def detect_suspicious_keywords(self, strings: List[str]) -> Dict:
        """
        Detect suspicious keywords in extracted strings
        
        Args:
            strings: List of extracted strings
            
        Returns:
            Dictionary with detected suspicious keywords
        """
        detected = []
        
        for string in strings:
            string_lower = string.lower()
            for keyword in self.SUSPICIOUS_KEYWORDS:
                if keyword.lower() in string_lower:
                    detected.append({
                        'keyword': keyword,
                        'context': string[:100]  # First 100 chars of context
                    })
        
        return {
            'total_detected': len(detected),
            'keywords': detected[:20],  # Limit to first 20 matches
            'suspicious': len(detected) > 0
        }
    
    def analyze_file(self, file_content: bytes) -> Dict:
        """
        Perform complete static analysis
        
        Args:
            file_content: Binary content of the file
            
        Returns:
            Dictionary with analysis results
        """
        try:
            # Extract strings
            strings = self.extract_strings(file_content)
            
            # Detect suspicious keywords
            keyword_analysis = self.detect_suspicious_keywords(strings)
            
            # Analyze URLs
            url_pattern = r'https?://[^\s<>"{}|\\^`\[\]]+'
            urls = []
            for s in strings:
                found_urls = re.findall(url_pattern, s)
                urls.extend(found_urls)
            
            # Analyze IP addresses
            ip_pattern = r'\b(?:\d{1,3}\.){3}\d{1,3}\b'
            ips = []
            for s in strings:
                found_ips = re.findall(ip_pattern, s)
                ips.extend(found_ips)
            
            return {
                'status': 'completed',
                'total_strings': len(strings),
                'sample_strings': strings[:20],  # First 20 strings
                'suspicious_keywords': keyword_analysis,
                'urls_found': list(set(urls))[:10],  # Unique URLs, max 10
                'ips_found': list(set(ips))[:10],  # Unique IPs, max 10
                'has_suspicious_content': keyword_analysis['suspicious'] or len(urls) > 0
            }
            
        except Exception as e:
            return {
                'status': 'error',
                'message': f'Static analysis failed: {str(e)}',
                'total_strings': 0,
                'suspicious_keywords': {'total_detected': 0, 'keywords': [], 'suspicious': False}
            }
