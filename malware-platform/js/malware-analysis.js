/**
 * Malware Analysis Platform - Frontend JavaScript
 */

const API_URL = 'http://localhost:8001';
let selectedFile = null;
let analysisReport = null;

// DOM Elements
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const analyzeBtn = document.getElementById('analyzeBtn');

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    setupFileUpload();
    checkBackendStatus();
});

// ============================================================================
// FILE UPLOAD HANDLING
// ============================================================================

function setupFileUpload() {
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
    });
    
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
    });
}

function handleFile(file) {
    // Validate file size (50MB max)
    if (file.size > 50 * 1024 * 1024) {
        alert('File too large! Maximum size is 50MB.');
        return;
    }
    
    selectedFile = file;
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileInfo').classList.remove('hidden');
    analyzeBtn.disabled = false;
}

function clearFile() {
    selectedFile = null;
    fileInput.value = '';
    document.getElementById('fileInfo').classList.add('hidden');
    analyzeBtn.disabled = true;
}

// ============================================================================
// ANALYSIS FUNCTIONS
// ============================================================================

async function analyzeFile() {
    if (!selectedFile) return;
    
    // Show loading section
    document.getElementById('uploadSection').classList.add('hidden');
    document.getElementById('loadingSection').classList.remove('hidden');
    
    // Animate progress
    animateProgress();
    
    try {
        // Create form data
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        // Send to backend
        const response = await fetch(`${API_URL}/api/analyze`, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Analysis failed');
        }
        
        analysisReport = await response.json();
        
        // Show results
        setTimeout(() => {
            displayResults(analysisReport);
        }, 1000);
        
    } catch (error) {
        console.error('Analysis error:', error);
        alert(`Analysis failed: ${error.message}`);
        resetAnalysis();
    }
}

function animateProgress() {
    const steps = ['step1', 'step2', 'step3', 'step4'];
    const progressBar = document.getElementById('progressBar');
    let currentStep = 0;
    
    const interval = setInterval(() => {
        if (currentStep < steps.length) {
            document.getElementById(steps[currentStep]).classList.add('active');
            progressBar.style.width = `${((currentStep + 1) / steps.length) * 100}%`;
            currentStep++;
        } else {
            clearInterval(interval);
        }
    }, 800);
}

// ============================================================================
// RESULTS DISPLAY
// ============================================================================

function displayResults(report) {
    document.getElementById('loadingSection').classList.add('hidden');
    document.getElementById('resultsSection').classList.remove('hidden');
    
    const risk = report.risk_assessment;
    
    // Display risk level
    const riskLevel = document.getElementById('riskLevel');
    riskLevel.textContent = risk.risk_level;
    riskLevel.className = `result-value ${risk.risk_color}`;
    
    document.getElementById('riskScore').textContent = `Score: ${risk.risk_score}/100`;
    
    // Display risk alert - show different messages based on risk level
    const riskAlert = document.getElementById('riskAlert');
    
    if (risk.risk_level === 'LOW' && risk.risk_score < 10) {
        // Clean file - show success message
        riskAlert.className = 'alert alert-success';
        riskAlert.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <div>
                <strong>✅ No Threats Detected</strong><br>
                This file appears to be clean. No malware signatures or suspicious patterns were found.
            </div>
        `;
    } else {
        // Threats detected - show warning/danger message
        riskAlert.className = `alert alert-${risk.risk_color}`;
        riskAlert.innerHTML = `
            <i class="fas fa-${risk.risk_color === 'danger' ? 'exclamation-triangle' : risk.risk_color === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
            <div><strong>${risk.recommendation}</strong></div>
        `;
    }
    
    // Display file info
    document.getElementById('resultFileName').textContent = report.file_info.filename;
    document.getElementById('resultFileSize').textContent = report.file_info.size_human;
    
    // Show hashes tab by default
    showTab('hashes');
}

function showTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    const content = document.getElementById('tabContent');
    
    switch(tabName) {
        case 'hashes':
            content.innerHTML = generateHashesTab();
            break;
        case 'virustotal':
            content.innerHTML = generateVirusTotalTab();
            break;
        case 'yara':
            content.innerHTML = generateYaraTab();
            break;
        case 'static':
            content.innerHTML = generateStaticTab();
            break;
    }
}

function generateHashesTab() {
    const hashes = analysisReport.hashes;
    return `
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">MD5</div>
                <div class="info-value hash">${hashes.md5}</div>
            </div>
            <div class="info-item">
                <div class="info-label">SHA1</div>
                <div class="info-value hash">${hashes.sha1}</div>
            </div>
            <div class="info-item">
                <div class="info-label">SHA256</div>
                <div class="info-value hash">${hashes.sha256}</div>
            </div>
        </div>
    `;
}

function generateVirusTotalTab() {
    const vt = analysisReport.scan_results.virustotal;
    
    if (vt.status === 'disabled') {
        return `<div class="alert alert-info"><i class="fas fa-info-circle"></i><div>${vt.message}</div></div>`;
    }
    
    if (vt.status === 'not_found') {
        return `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <div>
                    <strong>✅ Clean - Not in VirusTotal Database</strong><br>
                    This file hash was not found in VirusTotal's database, which typically indicates a clean or unknown file.
                </div>
            </div>
        `;
    }
    
    if (vt.status === 'found') {
        const percentage = ((vt.malicious / vt.total) * 100).toFixed(1);
        const isClean = vt.malicious === 0;
        
        if (isClean) {
            return `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>✅ Clean - Verified by VirusTotal</strong><br>
                        Scanned by ${vt.total} antivirus engines. No threats detected.
                    </div>
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Detection Rate</div>
                        <div class="info-value success">0 / ${vt.total} (0%)</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Status</div>
                        <div class="info-value success">Clean</div>
                    </div>
                </div>
            `;
        }
        
        return `
            <div class="alert alert-${vt.malicious > 5 ? 'danger' : 'warning'}">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>⚠️ Threats Detected by VirusTotal</strong><br>
                    ${vt.malicious} out of ${vt.total} antivirus engines flagged this file as malicious.
                </div>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Detection Rate</div>
                    <div class="info-value danger">${vt.malicious} / ${vt.total} (${percentage}%)</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Malicious</div>
                    <div class="info-value danger">${vt.malicious}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Suspicious</div>
                    <div class="info-value warning">${vt.suspicious}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Undetected</div>
                    <div class="info-value">${vt.undetected}</div>
                </div>
            </div>
        `;
    }
    
    return `<div class="alert alert-warning"><i class="fas fa-exclamation-circle"></i><div>${vt.message}</div></div>`;
}

function generateYaraTab() {
    const yara = analysisReport.scan_results.yara;
    
    if (yara.status === 'disabled') {
        return `<div class="alert alert-info"><i class="fas fa-info-circle"></i><div>${yara.message}</div></div>`;
    }
    
    if (!yara.threat_detected) {
        return `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <div>
                    <strong>✅ No Suspicious Patterns Detected</strong><br>
                    YARA rules did not find any malicious patterns or signatures in this file.
                </div>
            </div>
        `;
    }
    
    let html = `
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>⚠️ Suspicious Patterns Found</strong><br>
                YARA detected ${yara.matches.length} suspicious pattern(s) that may indicate malicious behavior.
            </div>
        </div>
    `;
    
    yara.matches.forEach(match => {
        html += `
            <div class="match-card">
                <h4><i class="fas fa-flag"></i> ${match.rule}</h4>
                <p><strong>Severity:</strong> ${match.meta.severity || 'Unknown'}</p>
                <p><strong>Description:</strong> ${match.meta.description || 'No description'}</p>
            </div>
        `;
    });
    
    return html;
}

function generateStaticTab() {
    const static_analysis = analysisReport.scan_results.static_analysis;
    
    let html = `
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Total Strings</div>
                <div class="info-value">${static_analysis.total_strings}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Suspicious Keywords</div>
                <div class="info-value ${static_analysis.suspicious_keywords.suspicious ? 'danger' : 'success'}">
                    ${static_analysis.suspicious_keywords.total_detected}
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">URLs Found</div>
                <div class="info-value">${static_analysis.urls_found.length}</div>
            </div>
            <div class="info-item">
                <div class="info-label">IPs Found</div>
                <div class="info-value">${static_analysis.ips_found.length}</div>
            </div>
        </div>
    `;
    
    // Show clean message if no suspicious content
    if (!static_analysis.has_suspicious_content) {
        html += `
            <div class="alert alert-success" style="margin-top: 1.5rem;">
                <i class="fas fa-check-circle"></i>
                <div>
                    <strong>✅ No Suspicious Content Found</strong><br>
                    Static analysis did not find any suspicious keywords, URLs, or patterns in the file.
                </div>
            </div>
        `;
        return html;
    }
    
    // Show suspicious keywords if found
    if (static_analysis.suspicious_keywords.keywords.length > 0) {
        html += `
            <div class="alert alert-warning" style="margin-top: 1.5rem;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>⚠️ Suspicious Keywords Detected</strong><br>
                    Found ${static_analysis.suspicious_keywords.total_detected} suspicious keyword(s) that may indicate malicious behavior.
                </div>
            </div>
            <h4 style="margin-top: 1.5rem;">Detected Keywords:</h4>
        `;
        static_analysis.suspicious_keywords.keywords.forEach(kw => {
            html += `
                <div class="keyword-card">
                    <strong>${kw.keyword}</strong>
                    <code>${escapeHtml(kw.context)}</code>
                </div>
            `;
        });
    }
    
    return html;
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function resetAnalysis() {
    document.getElementById('resultsSection').classList.add('hidden');
    document.getElementById('loadingSection').classList.add('hidden');
    document.getElementById('uploadSection').classList.remove('hidden');
    clearFile();
    analysisReport = null;
}

async function checkBackendStatus() {
    try {
        const response = await fetch(`${API_URL}/api/status`);
        if (response.ok) {
            console.log('Backend connected successfully');
        }
    } catch (error) {
        console.warn('Backend not available:', error);
    }
}

function showStatus() {
    // Hide other sections
    document.getElementById('uploadSection').classList.add('hidden');
    document.getElementById('loadingSection').classList.add('hidden');
    document.getElementById('resultsSection').classList.add('hidden');
    
    // Show or create status section
    let statusSection = document.getElementById('statusSection');
    if (!statusSection) {
        statusSection = document.createElement('section');
        statusSection.id = 'statusSection';
        statusSection.innerHTML = `
            <div class="card">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-server"></i></div>
                    <h2 class="card-title">Scanner Status</h2>
                </div>
                <div id="statusContent">
                    <div class="loading-status">
                        <div class="loading"></div>
                        <p>Checking scanner availability...</p>
                    </div>
                </div>
            </div>
        `;
        document.querySelector('.container').appendChild(statusSection);
    }
    
    statusSection.classList.remove('hidden');
    
    // Fetch status from backend
    fetchScannerStatus();
}

async function fetchScannerStatus() {
    try {
        const response = await fetch(`${API_URL}/api/status`);
        const status = await response.json();
        
        const statusContent = document.getElementById('statusContent');
        statusContent.innerHTML = `
            <div class="status-grid">
                <div class="status-card ${status.virustotal === 'configured' ? 'status-active' : 'status-inactive'}">
                    <div class="status-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <h3>VirusTotal</h3>
                    <p class="status-label">${status.virustotal === 'configured' ? 'Configured' : 'Not Configured'}</p>
                    <p class="status-desc">Online threat intelligence with 70+ AV engines</p>
                </div>
                
                <div class="status-card ${status.yara === 'available' ? 'status-active' : 'status-inactive'}">
                    <div class="status-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>YARA</h3>
                    <p class="status-label">${status.yara === 'available' ? 'Available' : 'Unavailable'}</p>
                    <p class="status-desc">Pattern-based malware detection</p>
                </div>
                
                <div class="status-card status-active">
                    <div class="status-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <h3>Static Analysis</h3>
                    <p class="status-label">Available</p>
                    <p class="status-desc">String extraction and keyword detection</p>
                </div>
            </div>
            
            <div class="alert alert-info" style="margin-top: 2rem;">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Note:</strong> The platform works with any combination of available scanners. 
                    YARA is optional and can be installed for enhanced detection capabilities.
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="backToAnalysis()" style="margin-top: 1rem;">
                <i class="fas fa-arrow-left"></i> Back to Analysis
            </button>
        `;
    } catch (error) {
        console.error('Failed to fetch status:', error);
        document.getElementById('statusContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                <div>Failed to connect to backend. Please ensure the server is running.</div>
            </div>
        `;
    }
}

function backToAnalysis() {
    document.getElementById('statusSection').classList.add('hidden');
    document.getElementById('uploadSection').classList.remove('hidden');
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}


// ============================================================================
// ANIMATED BACKGROUND EFFECTS
// ============================================================================

function initBackgroundAnimations() {
    // Create floating particles
    createParticles(20);
    
    // Add entrance animations to elements
    addEntranceAnimations();
}

function createParticles(count) {
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        // Random position
        particle.style.left = Math.random() * 100 + '%';
        
        // Random animation duration (10-30 seconds)
        const duration = 10 + Math.random() * 20;
        particle.style.animationDuration = duration + 's';
        
        // Random delay
        particle.style.animationDelay = Math.random() * 5 + 's';
        
        // Random size
        const size = 2 + Math.random() * 4;
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        
        document.body.appendChild(particle);
    }
}

function addEntranceAnimations() {
    // Observe elements entering viewport
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.animation = 'slideUp 0.6s ease-out';
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });
    
    // Observe cards and result elements
    document.querySelectorAll('.card, .result-card, .stat-card').forEach(el => {
        observer.observe(el);
    });
}

// Initialize animations when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBackgroundAnimations);
} else {
    initBackgroundAnimations();
}

// Add ripple effect to buttons
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('btn-primary') || e.target.closest('.btn-primary')) {
        const button = e.target.classList.contains('btn-primary') ? e.target : e.target.closest('.btn-primary');
        const ripple = document.createElement('span');
        const rect = button.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            left: ${x}px;
            top: ${y}px;
            pointer-events: none;
            animation: ripple 0.6s ease-out;
        `;
        
        button.style.position = 'relative';
        button.style.overflow = 'hidden';
        button.appendChild(ripple);
        
        setTimeout(() => ripple.remove(), 600);
    }
});

// Add ripple animation
const style = document.createElement('style');
style.textContent = `
    @keyframes ripple {
        from {
            transform: scale(0);
            opacity: 1;
        }
        to {
            transform: scale(2);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
